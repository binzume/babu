Title: ばばばば ば ばぶばば ばぶばば ぶぶぶ
Subtitle: モールス符号を「バ」と「ブ」で表現する装置
Author: @binzume
Author(romaji): binzume

## とある会社のSlackにて

tboffice『もしもし』

tboffice『モールス信号を「バ」と「ブ」で表現する装置作って欲しい』

僕『？？？』

というわけなのでそれらしいものを作ります．使える時間が休日１日＋αくらいなので手早くやります．

## ハードウェア

### AquesTalk pico

自分でサンプリングして再生するのも考えましたが，めんどい＆自分の声をテストに使うとやる気が終了しそうだったので，
秋葉原の秋月電子に行って AquesTalk pico を買ってきました．自転車で往復30分．

棒読みちゃん等でも使われている AquesTalk のハードウェア版です．
ワンチップの部品で，電源とスピーカーをつなげば，後はシリアルポートにローマ字テキストをを流し込むと喋ってくれます．
初めて使ってみましたが，とても簡単に使えて素晴らしいです．

まずはPCにUSBシリアル変換基盤をつないで，適当なターミナルから「?」を入力すると「>」というプロンプトが返ってくるのを確認．
「konnichiwa.」+ エンター を入力すると「こんにちわ」と喋ってくれます．ここまで1時間．

とても簡単です．バブみ，あります(無理やり後付け)

### 回路

モールス符号の短点で「ば」，長点で「ぶ」と喋る予定ですが，「ば」と「ぶ」しか使わないのはもったいないので
アルファベットをしゃべってくれる機能を付けたい．
こういうとき，Arduinoが簡単で良いですが，ATMEGA88がたくさん余っていたので，有効活用．
AquesTalk pico も中身はAVRでした．

TODO: 回路図

ATMEGA88に入力用のボタンつけて，あとは AquesTalk pico の TX,RX をつなぐだけです．

### 電鍵

要はスイッチです．
モールス信号用のものが市販されてますが，良い感じのやつは高かった．
なので，良い感じのやつを3Dプリンタで作りたかったんですが時間切れ．


## プログラム

- ボタンの押された時間の長さによって「ば」「ぶ」をしゃべる
- しばらく入力がなかったら，それまでの入力のアルファベットをしゃべる

### タイミング

ちゃんと計測してはいないですがAquesTalk pico にデータを渡してしゃべり始めるまでに数十ミリ秒のラグがあります．
通常の利用では全く問題ない遅延ですが，キーのON/OFFに合わせてリアルタイムで発声させるには，厳しいです．

先に答えを書いてしまうと，キーがONになって早い段階で，短点に対応する「ba」を出力してしまいます．
その後，キーの状態を監視して長点だと判明した瞬間に先に送った命令を中止し，改めて「bu-」を送ります．
長点は短点に比べると少し遅延しても許容できそうなのでこのようにしました．

稀に長点が「bbu-」のようにbの子音が重なった感じに聞こえてしまいのは愛嬌ということにして諦めることにしました．


以下のコードは擬似コードです．THRESHOLDは短点と長点の閾値を表す定数です．


#### ダメな実装１

```
if (キーが押された) {
  duration = キーのON→OFFまでの時間を計測();
  if (duration < THRESHOLD) {
    talk("ba");
  } else {
    talk("bu-");
  }
}
```

キーを離すまで発声しないのでダメですね．

#### ダメな実装２


```
if (キーが押された) {
  duration =  キーのON→OFF もしくは THRESHOLD時間経過した？();
  if (duration < THRESHOLD) {
    talk("ba");
  } else {
    talk("bu-");
  }
}
```

最初に試しに実装したのがこれです．ダメでした．


#### マシな実装

```
　if (キーが押された) {
    sleep(ちょっと待つ);
    talk("ba");
    duration =  キーのON→OFF もしくは THRESHOLD時間経過した？();
    if (duration >= THRESHOLD) {
      talk_stop(); // 最初のbaを中断する
      talk("bu-");
    }
  }
```

とりあえず投機的に「ば」の発声コマンドを送り，長点だと分かったタイミングで中断して「ぶー」の発声コマンドを送るようにして妥協．

## 最後に

今回はさすがにやっつけ過ぎた感がありますが，簡単に音声合成できるの良いですね．


